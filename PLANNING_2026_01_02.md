# Deep Architecture Analysis - January 2, 2026

## Executive Summary

**Our current approach is fundamentally flawed and should be abandoned in favor of using Anthropic's proven harness.**

After reviewing:
1. Our codebase and yesterday's debugging session
2. Anthropic's official [long-running agent harness documentation](https://www.anthropic.com/engineering/effective-harnesses-for-long-running-agents)
3. The [Claude Agent SDK](https://www.anthropic.com/engineering/building-agents-with-the-claude-agent-sdk)
4. The [autonomous-coding quickstart](https://github.com/anthropics/claude-quickstarts/tree/main/autonomous-coding)

I've identified several critical architectural issues that explain why we got stuck yesterday.

---

## Critical Issues with Current Architecture

### Issue 1: Master URL Cannot Work (Showstopper)

In `startup_script.py` line 122:
```python
master_url=app_config.master_server_url or "http://localhost:8000"
```

The VM tries to call `localhost:8000` - but that's the VM's localhost, not your machine! The heartbeat will never reach the master server. This is why we couldn't verify if agents ran.

**Fix required:** Would need public IP, ngrok tunnel, or Cloud Run deployment.

### Issue 2: gsutil Not Installed (Bug)

Line 158 tries to upload screenshots:
```bash
gsutil -m cp /workspace/screenshots/* gs://{bucket}/...
```

But the Google Cloud SDK is never installed. This silently fails.

### Issue 3: No Progress Persistence

Anthropic's harness uses:
- `feature_list.json` - tracks all tasks with pass/fail status
- `claude-progress.txt` - session notes for continuity
- Git commits - structured history

Our approach: Write to `/workspace/agent.log` (never uploaded), then shutdown.

### Issue 4: VM Shuts Down Immediately

Line 166: `shutdown -h now`

No matter what happens, successful or failed, logs are lost. No delay, no upload.

### Issue 5: Over-Engineered, Under-Tested

We have ~50 Python files, but:
- Zero end-to-end tests that actually run an agent
- `PROGRESS.md` says "End-to-end workflow works ✅" - this is false
- Each test cycle requires GCP VM creation (5-10 min, $0.02/attempt)

### Issue 6: Wrong Abstraction Level

| Our Approach | Anthropic's Approach |
|--------------|---------------------|
| 1 GCP VM per agent | Local Python process |
| Complex startup script installs everything | Pre-configured environment |
| Master server callbacks | Local filesystem artifacts |
| VM termination ends session | Process restarts, reads progress files |
| $0.50-5/hour per agent | Just API calls |

We're solving "cloud VM orchestration" when the actual problem is "agent session management."

---

## Anthropic's Solution (What Actually Works)

From their autonomous-coding harness:

### Two-Agent Pattern
1. **Initializer Agent** (first session):
   - Creates project structure
   - Generates `feature_list.json` with all requirements
   - Sets up `init.sh` for environment

2. **Coding Agent** (subsequent sessions):
   - Reads progress files
   - Picks next incomplete feature
   - Implements, tests, commits
   - Updates `feature_list.json`

### Session Lifecycle
```bash
# Simple - just run locally
python autonomous_agent_demo.py --project-dir ./my_project
```

Each session:
1. Reads `feature_list.json` and git history
2. Works on next incomplete feature
3. Writes progress to files and commits
4. Can be interrupted and resumed anytime

### Key Insight
Progress is persisted to **files**, not a server. Git commits + JSON files survive context window limits. No master server needed.

---

## Recommendation: Pivot to Anthropic's Harness

### Why This is the Right Decision

1. **Anthropic has solved the hard problems** - session management, progress tracking, context preservation are done
2. **It's proven at scale** - Users run 24/7 (even consuming "tens of thousands of dollars" per month per Anthropic)
3. **Your goal is to use this harness** - "I want to launch a 24/7 continuous agent with the Anthropic 24/7 harness ASAP"
4. **Our approach doesn't work** - Multiple hours debugging, still can't verify a single successful run

### Proposed Architecture

```
┌─────────────────────────────────────────────────────┐
│                   agentctl CLI                       │
│  (orchestration layer - what we're building)        │
├─────────────────────────────────────────────────────┤
│                 Claude Agent SDK                     │
│  (autonomous-coding harness - Anthropic's work)     │
├─────────────────────────────────────────────────────┤
│                   Claude Code CLI                    │
│  (the actual agent - npm package)                   │
└─────────────────────────────────────────────────────┘
```

**Our value-add:**
- Easy setup (`agentctl init`)
- Multiple concurrent agents
- Cloud deployment option (later)
- Monitoring dashboard (later)

**What we DON'T need to build:**
- Session management
- Progress tracking
- Context preservation
- The core agent harness

---

## Concrete Action Plan

### Phase 1: Get Something Working TODAY (2-3 hours)

1. **Clone Anthropic's autonomous-coding demo**
   ```bash
   git clone https://github.com/anthropics/claude-quickstarts.git
   cd claude-quickstarts/autonomous-coding
   ```

2. **Run it locally** to verify it works
   ```bash
   pip install -r requirements.txt
   python autonomous_agent_demo.py --project-dir ./test_project --max-iterations 3
   ```

3. **Understand the code** - read `agent.py`, `progress.py`, prompts

This gives you a working 24/7 agent harness TODAY.

### Phase 2: Build agentctl as Orchestration Layer (1-2 days)

1. **Simplify agentctl** to wrap the autonomous-coding harness
   ```bash
   agentctl run "Build a todo app"  # starts local agent
   agentctl status                   # shows agent progress
   agentctl logs                     # tails agent output
   agentctl stop                     # interrupts agent
   ```

2. **Remove** all the complex GCP/VM code for now

3. **Add** multi-agent support (run multiple local agents)

### Phase 3: Cloud Deployment (Optional, Later)

Once local works perfectly:
- Add option to run on GCP VM (single VM, long-lived)
- Or use tmux/screen on a cheap always-on VM
- Or containerize with Docker Compose

This is NOT needed for MVP.

---

## Files to Keep vs Remove

### Keep (core infrastructure)
- `agentctl/cli/main.py` - CLI entry point
- `agentctl/cli/run.py` - simplified to launch local agent
- `agentctl/shared/config.py` - configuration management
- Tests that work

### Remove/Archive (over-engineered)
- `agentctl/server/` - don't need master server
- `agentctl/server/services/vm_manager.py` - don't need VM orchestration
- `agentctl/server/services/startup_script.py` - don't need complex startup scripts
- `agentctl/server/routes/` - don't need REST API

### Add (from Anthropic)
- Adapt autonomous-coding harness into `agentctl/agent/`
- Progress tracking utilities
- Feature list management

---

## Alternative: Fix Current Approach

If you prefer to fix rather than pivot:

1. Fix master URL - deploy to Cloud Run or use ngrok
2. Install gsutil in startup script
3. Add log upload before shutdown
4. Add 60-second delay for debugging
5. Create Docker-based local test
6. Add progress file pattern
7. Fix all edge cases

Estimated time: 2-3 more days of debugging
Risk: More unknown issues will surface

**I don't recommend this path.** It's fighting the architecture instead of using a proven solution.

---

## Parallel Work Option

You mentioned wanting a separate agent on a separate branch. Suggested split:

**Branch 1 (main):** Pivot to Anthropic harness
- Get autonomous-coding demo working
- Integrate into simplified agentctl

**Branch 2 (feature/quick-spin):** Quick experiment
- Minimal script to run Claude Code with a prompt
- Single Python file, no server
- For rapid prototyping

---

## Questions for You

1. **Do you want to pivot** to Anthropic's harness, or fix the current approach?

2. **What's your minimum viable agent?**
   - Just Claude Code running with progress tracking?
   - Or do you need cloud VMs, monitoring, etc?

3. **How important is cloud deployment** vs local execution?

4. **For the parallel agent** - what feature should it work on?

---

## Sources

- [Effective Harnesses for Long-Running Agents](https://www.anthropic.com/engineering/effective-harnesses-for-long-running-agents)
- [Building Agents with the Claude Agent SDK](https://www.anthropic.com/engineering/building-agents-with-the-claude-agent-sdk)
- [Autonomous Coding Quickstart](https://github.com/anthropics/claude-quickstarts/tree/main/autonomous-coding)
